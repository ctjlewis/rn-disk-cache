{"version":3,"file":"rn-disk-cache.production.min.cjs","sources":["../src/index.ts"],"sourcesContent":["import { join } from 'path';\nimport fs from 'react-native-fs';\nconst {\n  DocumentDirectoryPath,\n  mkdir,\n  readDir,\n  readFile,\n  unlink,\n  writeFile,\n} = fs;\n\n/**\n * The directory where caches will be stored.\n */\nconst CACHE_DIR = join(DocumentDirectoryPath, '__caches__');\n\n/**\n * Cache an object on the filesystem for a given amount of time.\n *\n * @param name A tag that will be used to name the temp directory.\n * @param fn A function that returns, or Promise that resolves to, the object to\n * cache.\n * @param seconds The number of seconds to cache the object for.\n */\nexport const fromDiskCache = async <T>(\n  name: string,\n  fn: () => T | Promise<T>,\n  seconds = 60 * 60\n): Promise<T> => {\n  /**\n   * The path to this cache, i.e. ${CACHE_DIR}/myCache. Create it if it doesn't\n   * exist.\n   */\n  const cachePath = join(CACHE_DIR, name);\n  await mkdir(cachePath);\n  /**\n   * Available caches in this store.\n   */\n  const cacheResults = await readDir(cachePath);\n  const caches = cacheResults.sort((a, b) => Number(b.name) - Number(a.name));\n  /**\n   * The most recent available cached value.\n   */\n  const mostRecentCache = caches[0];\n  /**\n   * The timestamp for the most recent cached value.\n   */\n  const mostRecentTimestamp = !mostRecentCache\n    ? 0\n    : Number(mostRecentCache.name);\n  /**\n   * Read the most recent cached value.\n   */\n  const readCache = async () => {\n    console.log('Reading most recent cache value.');\n    const cacheFile = join(cachePath, mostRecentCache.name);\n    const cacheValue = JSON.parse(await readFile(cacheFile));\n    return cacheValue;\n  };\n  /**\n   * Write the new value to the cache.\n   */\n  const writeCache = async () => {\n    console.log('Writing new cache value.');\n    const cacheValue = await fn();\n    const cacheTimestamp = Date.now();\n    const cacheFile = join(cachePath, `${cacheTimestamp}`);\n    const serialized = JSON.stringify(cacheValue);\n    console.log('LENGTH', caches.length);\n    /**\n     * Delete all existing caches.\n     */\n    if (caches.length > 1) {\n      console.log('Deleting old caches.');\n      const cachesToDelete = caches.slice(1);\n      await Promise.all(\n        cachesToDelete.map(\n          async (cache) => await unlink(cache.path)\n        )\n      );\n    }\n    /**\n     * Write new cache and return.\n     */\n    await writeFile(cacheFile, serialized);\n    return cacheValue;\n  };\n  /**\n   * If no caches were found, write a new value.\n   */\n  if (!caches.length) {\n    console.log('No caches found.');\n    return await writeCache();\n  }\n  /**\n   * If caches were found, determine if they're stale.\n   */\n  const secondsOld = (Date.now() - mostRecentTimestamp) / 1000;\n  const cacheIsStale = secondsOld >= seconds;\n  console.log(`Caches found for store: ${name}`, { cacheIsStale, secondsOld });\n  /**\n   * If the cache is not stale, read the value and return it.\n   */\n  if (cacheIsStale) {\n    console.log('Cache is stale.');\n    return await writeCache();\n  } else {\n    console.log('Cache is not stale.');\n    return await readCache();\n  }\n};\n"],"names":["DocumentDirectoryPath","mkdir","readDir","readFile","unlink","writeFile","fs","CACHE_DIR","join","async","name","fn","seconds","cachePath","caches","sort","a","b","Number","mostRecentCache","mostRecentTimestamp","writeCache","console","log","cacheValue","cacheTimestamp","Date","now","cacheFile","serialized","JSON","stringify","length","cachesToDelete","slice","Promise","all","map","cache","path","secondsOld","cacheIsStale","parse","readCache"],"mappings":"wMAEA,MAAMA,sBACJA,EAAqBC,MACrBA,EAAKC,QACLA,EAAOC,SACPA,EAAQC,OACRA,EAAMC,UACNA,GACEC,UAKEC,EAAYC,OAAKR,EAAuB,oCAUjBS,MAC3BC,EACAC,EACAC,EAAU,QAMV,MAAMC,EAAYL,OAAKD,EAAWG,SAC5BT,EAAMY,GAIZ,MACMC,SADqBZ,EAAQW,IACPE,MAAK,CAACC,EAAGC,IAAMC,OAAOD,EAAEP,MAAQQ,OAAOF,EAAEN,QAI/DS,EAAkBL,EAAO,GAIzBM,EAAuBD,EAEzBD,OAAOC,EAAgBT,MADvB,EAcEW,EAAaZ,UACjBa,QAAQC,IAAI,4BACZ,MAAMC,QAAmBb,IACnBc,EAAiBC,KAAKC,MACtBC,EAAYpB,OAAKK,EAAW,GAAGY,KAC/BI,EAAaC,KAAKC,UAAUP,GAKlC,GAJAF,QAAQC,IAAI,SAAUT,EAAOkB,QAIzBlB,EAAOkB,OAAS,EAAG,CACrBV,QAAQC,IAAI,wBACZ,MAAMU,EAAiBnB,EAAOoB,MAAM,SAC9BC,QAAQC,IACZH,EAAeI,KACb5B,MAAO6B,SAAgBlC,EAAOkC,EAAMC,SAQ1C,aADMlC,EAAUuB,EAAWC,GACpBL,GAKT,IAAKV,EAAOkB,OAEV,OADAV,QAAQC,IAAI,0BACCF,IAKf,MAAMmB,GAAcd,KAAKC,MAAQP,GAAuB,IAClDqB,EAAeD,GAAc5B,EAKnC,OAJAU,QAAQC,IAAI,2BAA2Bb,IAAQ,CAAE+B,aAAAA,EAAcD,WAAAA,IAI3DC,GACFnB,QAAQC,IAAI,yBACCF,MAEbC,QAAQC,IAAI,4BAtDId,WAChBa,QAAQC,IAAI,oCACZ,MAAMK,EAAYpB,OAAKK,EAAWM,EAAgBT,MAElD,OADmBoB,KAAKY,YAAYvC,EAASyB,KAoDhCe"}