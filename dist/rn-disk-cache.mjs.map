{"version":3,"file":"rn-disk-cache.mjs","sources":["../src/index.ts"],"sourcesContent":["import { join } from 'path';\nimport {\n  DocumentDirectoryPath,\n  mkdir,\n  readDir,\n  readFile,\n  unlink,\n  writeFile,\n} from 'react-native-fs';\n\n/**\n * The directory where caches will be stored.\n */\nconst CACHE_DIR = join(DocumentDirectoryPath, '__caches__');\n\n/**\n * Cache an object on the filesystem for a given amount of time.\n *\n * @param name A tag that will be used to name the temp directory.\n * @param fn A function that returns, or Promise that resolves to, the object to\n * cache.\n * @param seconds The number of seconds to cache the object for.\n */\nexport const fromDiskCache = async <T>(\n  name: string,\n  fn: () => T | Promise<T>,\n  seconds = 60 * 60\n): Promise<T> => {\n  /**\n   * The path to this cache, i.e. ${CACHE_DIR}/myCache. Create it if it doesn't\n   * exist.\n   */\n  const cachePath = join(CACHE_DIR, name);\n  await mkdir(cachePath);\n  /**\n   * Available caches in this store.\n   */\n  const caches = await readDir(cachePath);\n  /**\n   * The most recent available cached value.\n   */\n  const mostRecentCache = caches.sort()[caches.length - 1];\n  /**\n   * The timestamp for the most recent cached value.\n   */\n  const mostRecentTimestamp = !mostRecentCache\n    ? 0\n    : Number(mostRecentCache.name);\n  /**\n   * Read the most recent cached value.\n   */\n  const readCache = async () => {\n    console.log('Reading most recent cache value.');\n    const cacheFile = join(cachePath, mostRecentCache.name);\n    const cacheValue = JSON.parse(await readFile(cacheFile));\n    return cacheValue;\n  };\n  /**\n   * Write the new value to the cache.\n   */\n  const writeCache = async () => {\n    console.log('Writing new cache value.');\n    const cacheValue = await fn();\n    const cacheTimestamp = Date.now();\n    const cacheFile = join(cachePath, `${cacheTimestamp}`);\n    const serialized = JSON.stringify(cacheValue);\n    /**\n     * Delete all existing caches.\n     */\n    console.log('Deleting existing caches.');\n    for (const cache of caches) {\n      unlink(cache.path);\n    }\n    /**\n     * Write new cache and return.\n     */\n    await writeFile(cacheFile, serialized);\n    return cacheValue;\n  };\n  /**\n   * If no caches were found, write a new value.\n   */\n  if (!caches.length) {\n    console.log('No caches found.');\n    return await writeCache();\n  }\n  /**\n   * If caches were found, determine if they're stale.\n   */\n  const secondsOld = (Date.now() - mostRecentTimestamp) / 1000;\n  const cacheIsStale = secondsOld >= seconds;\n  console.log(`Caches found for store: ${name}`, { cacheIsStale, secondsOld });\n  /**\n   * If the cache is not stale, read the value and return it.\n   */\n  if (cacheIsStale) {\n    console.log('Cache is stale.');\n    return await writeCache();\n  } else {\n    console.log('Cache is not stale.');\n    return await readCache();\n  }\n};\n"],"names":[],"mappings":";;;AAUA;;;AAGA,MAAM,SAAS,GAAG,IAAI,CAAC,qBAAqB,EAAE,YAAY,CAAC,CAAC;AAE5D;;;;;;;;MAQa,aAAa,GAAG,OAC3B,IAAY,EACZ,EAAwB,EACxB,OAAO,GAAG,EAAE,GAAG,EAAE;;;;;IAMjB,MAAM,SAAS,GAAG,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;IACxC,MAAM,KAAK,CAAC,SAAS,CAAC,CAAC;;;;IAIvB,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,SAAS,CAAC,CAAC;;;;IAIxC,MAAM,eAAe,GAAG,MAAM,CAAC,IAAI,EAAE,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;;;;IAIzD,MAAM,mBAAmB,GAAG,CAAC,eAAe;UACxC,CAAC;UACD,MAAM,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;;;;IAIjC,MAAM,SAAS,GAAG;QAChB,OAAO,CAAC,GAAG,CAAC,kCAAkC,CAAC,CAAC;QAChD,MAAM,SAAS,GAAG,IAAI,CAAC,SAAS,EAAE,eAAe,CAAC,IAAI,CAAC,CAAC;QACxD,MAAM,UAAU,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC;QACzD,OAAO,UAAU,CAAC;KACnB,CAAC;;;;IAIF,MAAM,UAAU,GAAG;QACjB,OAAO,CAAC,GAAG,CAAC,0BAA0B,CAAC,CAAC;QACxC,MAAM,UAAU,GAAG,MAAM,EAAE,EAAE,CAAC;QAC9B,MAAM,cAAc,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAClC,MAAM,SAAS,GAAG,IAAI,CAAC,SAAS,EAAE,GAAG,cAAc,EAAE,CAAC,CAAC;QACvD,MAAM,UAAU,GAAG,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;;;;QAI9C,OAAO,CAAC,GAAG,CAAC,2BAA2B,CAAC,CAAC;QACzC,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE;YAC1B,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;SACpB;;;;QAID,MAAM,SAAS,CAAC,SAAS,EAAE,UAAU,CAAC,CAAC;QACvC,OAAO,UAAU,CAAC;KACnB,CAAC;;;;IAIF,IAAI,CAAC,MAAM,CAAC,MAAM,EAAE;QAClB,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC;QAChC,OAAO,MAAM,UAAU,EAAE,CAAC;KAC3B;;;;IAID,MAAM,UAAU,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,mBAAmB,IAAI,IAAI,CAAC;IAC7D,MAAM,YAAY,GAAG,UAAU,IAAI,OAAO,CAAC;IAC3C,OAAO,CAAC,GAAG,CAAC,2BAA2B,IAAI,EAAE,EAAE,EAAE,YAAY,EAAE,UAAU,EAAE,CAAC,CAAC;;;;IAI7E,IAAI,YAAY,EAAE;QAChB,OAAO,CAAC,GAAG,CAAC,iBAAiB,CAAC,CAAC;QAC/B,OAAO,MAAM,UAAU,EAAE,CAAC;KAC3B;SAAM;QACL,OAAO,CAAC,GAAG,CAAC,qBAAqB,CAAC,CAAC;QACnC,OAAO,MAAM,SAAS,EAAE,CAAC;KAC1B;AACH;;;;"}