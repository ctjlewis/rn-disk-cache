import{join as e}from"path";import a from"react-native-fs";const{DocumentDirectoryPath:t,mkdir:c,readDir:s,readFile:i,unlink:n,writeFile:r}=a,o=e(t,"__caches__");class h{name;cachePath;constructor(a){this.name=a,this.cachePath=e(o,this.name)}log(...e){return console.log(`CACHE [${this.name}]`,...e),this}deleteCaches=async e=>{this.log(`Deleting ${e?"all":"old"} caches.`);const a=await this.getCaches(),t=e?a:a.slice(1);return await Promise.all(t.map((async e=>await n(e.path)))),this};getCaches=async()=>(await c(this.cachePath),(await s(this.cachePath)).sort(((e,a)=>Number(a.name)-Number(e.name))));getMostRecentCache=async()=>(await this.getCaches())[0];read=async()=>{this.log("Reading most recent cache value.");const e=await this.getMostRecentCache(),a=await i(e.path);return JSON.parse(a)};write=async a=>{this.log("Writing new cache value.");const t=e(this.cachePath,`${Date.now()}`);await this.deleteCaches(!1);const c=JSON.stringify(a);return await r(t,c),a}}const l=async(e,a,t=3600,...c)=>{const s=Date.now(),i=new h(e),n=async()=>{const e=await a(...c);return await i.write(e)};try{const a=await i.getMostRecentCache(),c=a?Number(a.name):0;if(!a)return i.log("No caches found."),await n();const r=(Date.now()-c)/1e3,o=r>=t;return i.log(`Caches found for store: ${e}`,{cacheIsStale:o,secondsOld:r}),o?(i.log("Cache is stale."),await n()):(i.log("Cache is not stale."),await i.read())}catch(e){throw i.log("Unrecoverable error. Files may be corrupted. Deleting all caches.",e),await i.deleteCaches(!0),new Error(`Error: ${e}`)}finally{i.log(`Finished in ${Date.now()-s}ms`)}};export{l as fromDiskCache};
export default {};
//# sourceMappingURL=rn-disk-cache.min.mjs.map
